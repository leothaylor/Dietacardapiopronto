<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cardápio Inteligente — MVP v5.7</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 UMD + ReactDOM 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel (JSX no navegador) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    html,body,#root{height:100%}
    body{background:#0a0a1a;color:#e5e7eb;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="preload" as="style" onload="this.rel='stylesheet'">
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
/* === Estado/Utilidades === */
const PROFILE_STORAGE_KEY = 'dietacardapio_profile_v1';
const LEGACY_PROFILE_STORAGE_KEY = "cardapio_profile_v5_3";
const LEGACY_ALL_DAYS_STORAGE_KEY = "cardapio_all_days_v5_6";
const LEGACY_SLOTS_STORAGE_KEY = "cardapio_slotkeys_v5_6";
const LEGACY_CURRENT_DAY_ID_STORAGE_KEY = "cardapio_current_day_id_v5_6";

const STORAGE_NAMESPACE = "cardapio_v6";
const PROFILES_INDEX_KEY = `${STORAGE_NAMESPACE}_profiles_index`;
const SELECTED_PROFILE_ID_KEY = `${STORAGE_NAMESPACE}_selected_profile_id`;
const makeProfileKey = (profileId, segment) => `${STORAGE_NAMESPACE}_${segment}_${profileId}`;

const INITIAL_DAY_ID = 'day-1';

const INPUT_RANGES = {
  age: { min: 10, max: 120, step: 1 },
  weight: { min: 30, max: 300, step: 0.5 },
  height: { min: 100, max: 250, step: 1 },
  neck: { min: 20, max: 60, step: 0.5 },
  waist: { min: 40, max: 150, step: 0.5 },
  hip: { min: 50, max: 150, step: 0.5 },
};

function normalizeAndValidateInput(key, value) {
  const range = INPUT_RANGES[key];
  let numericValue = Number(value);
  if (value === '' || value === null || Number.isNaN(numericValue)) return 0;
  if (range) {
    if (numericValue !== 0 && numericValue < range.min) return range.min;
    if (numericValue > range.max) return range.max;
  }
  return numericValue;
}

const resolveStaticAsset = (relativePath) => {
  try {
    return new URL(relativePath, window.location.href).toString();
  } catch (e) {
    console.warn("Falha ao resolver caminho estático", relativePath, e);
    return relativePath;
  }
};

const loadState = (key, defaultState) => {
  try {
    const raw = localStorage.getItem(key);
    if (raw === null || raw === "undefined") return defaultState;
    const state = JSON.parse(raw);
    return state;
  } catch(e){ console.error("loadState", key, e); return defaultState; }
};

const saveState = (key, state) => {
  try { localStorage.setItem(key, JSON.stringify(state)); }
  catch(e){ console.error("saveState", key, e); }
};

const removeState = (key) => {
  try { localStorage.removeItem(key); }
  catch(e){ console.error("removeState", key, e); }
};

const generateProfileId = () => {
  try {
    if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();
  } catch (e) {
    console.warn("randomUUID indisponível", e);
  }
  return `profile-${Math.random().toString(36).slice(2,10)}-${Date.now()}`;
};

/* === Cálculos === */
const KCAL_PER_G = { protein: 4, carbs: 4, fats: 9 };
const round = (n, d=0) => { const p = 10**d; return Math.round(n*p)/p; };

function calcBMR({ sex, weight, height, age }) {
  const s = sex === "F" ? -161 : 5;
  return 10*weight + 6.25*height - 5*age + s;
}
function calcTDEE(bmr, activity) {
  const factors = { sedentary:1.2, light:1.375, moderate:1.55, active:1.725, very:1.9 };
  return bmr * (factors[activity] || 1.55);
}
function adjustForGoal(tdee, goal) {
  if (goal === "loss") return tdee*0.85;
  if (goal === "gain") return tdee*1.1;
  if (goal === "recomp") return tdee*0.95;
  return tdee;
}
function deriveMacroTargets({ weight, calories }) {
  const proteinG = 1.8*weight, fatG = 0.8*weight;
  const kcalProtein = proteinG*KCAL_PER_G.protein, kcalFats = fatG*KCAL_PER_G.fats;
  const carbG = Math.max(0, calories - kcalProtein - kcalFats) / KCAL_PER_G.carbs;
  return { protein: round(proteinG), fats: round(fatG), carbs: round(carbG) };
}
/* %Gordura US Navy */
function calcBF({ sex, height, neck, waist, hip }) {
  const CM_TO_INCH = 0.393701;
  const h = (height||0)*CM_TO_INCH, n=(neck||0)*CM_TO_INCH, w=(waist||0)*CM_TO_INCH, hp=(hip||0)*CM_TO_INCH;
  if (h<=0 || n<=0 || w<=0) return null;
  if (sex==="F" && hp<=0) return null;
  try{
    if (sex==="M") {
      const f = w-n; if (f<=0) return null;
      return Math.max(3, 86.010*Math.log10(f) - 70.041*Math.log10(h) + 36.76);
    } else {
      const f = w+hp-n; if (f<=0) return null;
      return Math.max(8, 163.205*Math.log10(f) - 97.684*Math.log10(h) - 78.387);
    }
  }catch{ return null; }
}
function calculateMealMacros(entry){
  const p=entry.protein||0, c=entry.carbs||0, f=entry.fats||0;
  const baseKcal = entry.baseKcal || (p*4 + c*4 + f*9);
  const portion = entry.portion || 1;
  return { kcal: baseKcal*portion, protein:p*portion, carbs:c*portion, fats:f*portion };
}

/* === Dados de refeições (mesmos do seu app) === */
const DEFAULT_MEALS = [
  { id:"whey_agua", name:"Whey Protein Isolado (Água)", block:"250", tags:["High Protein","Low Carb","Quick"], ingredients:[{ name:"Whey Protein (1 Scoop)", protein:25, carbs:5, fats:4, baseKcal:155 }] },
  { id:"shake_caseina", name:"Shake de Caseína (Pré-Cama)", block:"250", tags:["High Protein","Low Carb"], ingredients:[{ name:"Caseína/Whey", protein:30, carbs:4, fats:3, baseKcal:170 }] },
  { id:"ovo_cozido", name:"2 Ovos Cozidos", block:"250", tags:["High Protein","Low Carb","High Fat"], ingredients:[{ name:"Ovo Cozido (2 unid.)", protein:12, carbs:1, fats:10, baseKcal:140 }] },
  { id:"fruta_pasta_amendoim", name:"Banana + Pasta de Amendoim", block:"250", tags:["High Carb","Balanced","Plant-Based"], ingredients:[{ name:"Banana (média)", protein:1, carbs:27, fats:0, baseKcal:105 }, { name:"Pasta de Amendoim (1 col. sopa)", protein:6, carbs:8, fats:8, baseKcal:145 }] },

  { id:"tapioca_ovo_queijo", name:"Tapioca c/ Ovos e Queijo Minas", block:"350", tags:["Balanced","Quick","BR"], ingredients:[{ name:"Massa de Tapioca (40g)", protein:0, carbs:35, fats:0, baseKcal:140 }, { name:"2 Ovos + 1 Clara", protein:18, carbs:0, fats:10, baseKcal:160 }, { name:"Queijo Minas (30g)", protein:7, carbs:0, fats:5, baseKcal:60 }] },
  { id:"shake_prot_pos", name:"Shake Pós-Treino Rápido (Completo)", block:"350", tags:["High Protein","Post-Workout","High Carb"], ingredients:[{ name:"Whey Protein (1 Scoop)", protein:25, carbs:5, fats:4, baseKcal:155 }, { name:"Banana (pequena)", protein:1, carbs:23, fats:0, baseKcal:90 }, { name:"Aveia (1 col. sopa)", protein:4, carbs:12, fats:2, baseKcal:80 }] },
  { id:"iogurte_prot_fruta", name:"Iogurte Proteico + Aveia e Fruta", block:"350", tags:["Balanced","Quick"], ingredients:[{ name:"Iogurte Natural/Grego (170g)", protein:10, carbs:15, fats:9, baseKcal:180 }, { name:"Aveia (15g)", protein:3, carbs:9, fats:1, baseKcal:60 }, { name:"Banana (média)", protein:1, carbs:27, fats:0, baseKcal:105 }] },

  { id:"frango_arroz_feijao_padrao", name:"Frango, Arroz, Feijão (Almoço Padrão)", block:"500", tags:["Balanced","High Protein","BR"], ingredients:[{ name:"Arroz Integral Cozido (100g)", protein:2, carbs:28, fats:1, baseKcal:130 }, { name:"Feijão Cozido (100g)", protein:5, carbs:15, fats:1, baseKcal:100 }, { name:"Peito de Frango Grelhado (120g cru)", protein:34, carbs:0, fats:5, baseKcal:180 }, { name:"Azeite (1 col. chá)", protein:0, carbs:0, fats:5, baseKcal:45 }, { name:"Salada e Legumes (Livre)", protein:2, carbs:5, fats:0, baseKcal:30 }] },
  { id:"salmao_quinoa_espinafre", name:"Salmão Grelhado c/ Quinoa e Espinafre", block:"500", tags:["High Fat Saudável","Balanced"], ingredients:[{ name:"Salmão Grelhado (100g)", protein:25, carbs:0, fats:15, baseKcal:240 }, { name:"Quinoa Cozida (80g)", protein:3, carbs:14, fats:1, baseKcal:80 }, { name:"Espinafre Refogado (Livre)", protein:3, carbs:5, fats:5, baseKcal:70 }, { name:"Azeite (1 col. sopa)", protein:0, carbs:0, fats:13, baseKcal:117 }] },

  { id:"massa_pesto_frango_azeitonas", name:"Massa Integral c/ Pesto, Frango e Azeitonas", block:"750", tags:["High Carb","High Protein","Post-Workout"], ingredients:[{ name:"Massa Integral Cozida (150g)", protein:7, carbs:45, fats:2, baseKcal:230 }, { name:"Peito de Frango Picado (150g)", protein:40, carbs:0, fats:6, baseKcal:226 }, { name:"Molho Pesto (2 col. sopa)", protein:5, carbs:5, fats:20, baseKcal:220 }, { name:"Tomate Seco e Azeitonas", protein:0, carbs:5, fats:6, baseKcal:70 }] },
];

const addTotalsToMeals = (mealsList) => mealsList.map(meal => {
  const totals = meal.ingredients.reduce((acc, ing) => {
    const m = calculateMealMacros({ ...ing, portion: 1 });
    acc.protein+=m.protein; acc.carbs+=m.carbs; acc.fats+=m.fats; acc.kcal+=m.kcal; return acc;
  }, { protein:0, carbs:0, fats:0, kcal:0 });
  return { ...meal, ...totals };
});
const PORTION_OPTIONS = [0.5, 1, 1.5, 2];

const MinimizeButton = ({ isMinimized, toggleMinimize }) => (
  <button onClick={toggleMinimize} className="text-slate-400 hover:text-slate-200 transition p-1 rounded-full bg-slate-700/50 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500" title={isMinimized ? "Expandir seção":"Minimizar seção"} aria-label={isMinimized ? "Expandir seção":"Minimizar seção"}>
    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={isMinimized ? "M19 9l-7 7-7-7" : "M5 15l7-7 7 7"}></path></svg>
  </button>
);

function Stat({ label, value, unit="", target }) {
  const pct = Math.min(100, Math.max(0, (value/(target||1))*100));
  const ok = target ? value <= target*1.05 : true;
  return (
    <div className="mb-3">
      <div className="flex justify-between text-sm text-slate-300">
        <span>{label}</span>
        <span><strong className={ok ? "text-green-400":"text-red-400"}>{round(value,0)}{unit}</strong>{target && <span className="text-slate-400"> / {round(target,0)}{unit}</span>}</span>
      </div>
      <div className="h-2 bg-slate-700 rounded"><div style={{width:`${pct}%`}} className={`h-2 rounded transition-all duration-500 ${ok?"bg-green-500":"bg-red-500"}`} /></div>
    </div>
  );
}

function Pill({ active, children, onClick }) {
  return (
    <button onClick={onClick} className={`px-3 py-1 rounded-full text-sm mr-2 mb-2 border transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 ${active ? "bg-emerald-500/20 text-emerald-300 border-emerald-400 focus:ring-emerald-500" : "border-slate-600 text-slate-300 hover:bg-slate-700/40 focus:ring-slate-400"}`}>{children}</button>
  );
}
function Section({ title, children, right, isMinimized }) {
  return (
    <div className="bg-slate-800/70 rounded-2xl p-5 shadow-lg shadow-black/20 border border-slate-700/50">
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-slate-100 text-lg font-semibold tracking-tight">{title}</h2>{right}
      </div>
      {!isMinimized && children}
    </div>
  );
}

const DEFAULT_PROFILE = { sex:"M", age:33, weight:73, height:170, activity:"moderate", goal:"recomp", neck:36, waist:85, hip:95, photoUrl:'https://placehold.co/100x100/1E293B/E2E8F0?text=Foto' };

function sanitizeProfile(rawProfile) {
  const candidate = { ...DEFAULT_PROFILE, ...(rawProfile || {}) };
  const validated = { ...candidate };
  let reset = false;

  Object.keys(INPUT_RANGES).forEach(k => {
    const range = INPUT_RANGES[k];
    const value = Number(candidate[k]);
    if (Number.isNaN(value) || value < range.min || value > range.max) {
      validated[k] = DEFAULT_PROFILE[k];
      reset = true;
    }
  });

  if (!['M','F'].includes(candidate.sex)) { validated.sex = DEFAULT_PROFILE.sex; reset = true; }
  if (!['loss','maintain','gain','recomp'].includes(candidate.goal)) { validated.goal = DEFAULT_PROFILE.goal; reset = true; }

  if (reset) console.warn("Perfil: valores inválidos restaurados.");
  return validated;
}
const INITIAL_SLOT_KEYS = [`slot-1`,`slot-2`,`slot-3`,`slot-4`];
const getInitialDayState = (keys) => keys.reduce((acc,k)=>({ ...acc, [k]:[] }),{});
const normalizeDays = (days, slotKeys) => {
  const base = days && typeof days === 'object' ? days : {};
  const normalized = {};
  const validSlots = Array.isArray(slotKeys) && slotKeys.length>0 ? slotKeys : INITIAL_SLOT_KEYS;
  const dayIds = Object.keys(base).length>0 ? Object.keys(base) : [INITIAL_DAY_ID];
  dayIds.forEach(id => {
    const dayData = base[id] && typeof base[id] === 'object' ? base[id] : {};
    normalized[id] = validSlots.reduce((acc, slot)=>({ ...acc, [slot]: Array.isArray(dayData[slot]) ? dayData[slot] : [] }), {});
  });
  return normalized;
};
const loadProfileBundle = (profileId) => {
  const storedProfile = sanitizeProfile(loadState(makeProfileKey(profileId, 'profile'), DEFAULT_PROFILE));
  const storedSlots = loadState(makeProfileKey(profileId, 'slots'), INITIAL_SLOT_KEYS);
  const slotKeys = Array.isArray(storedSlots) && storedSlots.length>0 ? storedSlots : INITIAL_SLOT_KEYS;
  const storedDays = loadState(makeProfileKey(profileId, 'days'), { [INITIAL_DAY_ID]: getInitialDayState(slotKeys) });
  const normalizedDays = normalizeDays(storedDays, slotKeys);
  const storedCurrentDay = loadState(makeProfileKey(profileId, 'current_day'), Object.keys(normalizedDays)[0] || INITIAL_DAY_ID);
  const currentDayId = normalizedDays[storedCurrentDay] ? storedCurrentDay : Object.keys(normalizedDays)[0] || INITIAL_DAY_ID;
  return {
    profile: storedProfile,
    slotKeys,
    allDays: normalizedDays,
    currentDayId,
  };
};

function App(){
  const { useMemo, useState, useEffect } = React;

  /* Estado + persistência */
  const [profiles, setProfiles] = useState([]);
  const [selectedProfileId, setSelectedProfileId] = useState(null);
  const [profile, setProfile] = useState(DEFAULT_PROFILE);
  const [isProfileLocked, setIsProfileLocked] = useState(false);
  const [slotKeys, setSlotKeys] = useState(INITIAL_SLOT_KEYS);
  const [currentDayId, setCurrentDayId] = useState(INITIAL_DAY_ID);
  const [allDays, setAllDays] = useState({ [INITIAL_DAY_ID]: getInitialDayState(INITIAL_SLOT_KEYS) });
  const [isInitialized, setIsInitialized] = useState(false);
  const [isProfileHydrating, setIsProfileHydrating] = useState(true);
  const [profileNameDraft, setProfileNameDraft] = useState('');
  const [isAddingProfile, setIsAddingProfile] = useState(false);
  const [newProfileName, setNewProfileName] = useState('');
  const day = allDays[currentDayId] || getInitialDayState(slotKeys);

  useEffect(()=>{
    setIsProfileHydrating(true);
    let profilesList = [];
    const storedProfiles = loadState(PROFILES_INDEX_KEY, null);
    if (Array.isArray(storedProfiles)) {
      profilesList = storedProfiles.filter(p=>p && p.id && p.name);
    }

    if (profilesList.length === 0) {
      const singleProfile = loadState(PROFILE_STORAGE_KEY, null);
      const legacyProfile = singleProfile || loadState(LEGACY_PROFILE_STORAGE_KEY, null);
      const legacySlots = loadState(LEGACY_SLOTS_STORAGE_KEY, null);
      const legacyDays = loadState(LEGACY_ALL_DAYS_STORAGE_KEY, null);
      const legacyCurrentDay = loadState(LEGACY_CURRENT_DAY_ID_STORAGE_KEY, null);
      const migratedId = generateProfileId();
      const migratedName = legacyProfile && typeof legacyProfile.name === 'string' && legacyProfile.name.trim().length>0 ? legacyProfile.name.trim() : 'Perfil Principal';
      const migratedSlots = Array.isArray(legacySlots) && legacySlots.length>0 ? legacySlots : INITIAL_SLOT_KEYS;
      const migratedDays = normalizeDays(legacyDays, migratedSlots);
      const migratedCurrentDay = migratedDays[legacyCurrentDay] ? legacyCurrentDay : Object.keys(migratedDays)[0] || INITIAL_DAY_ID;
      profilesList = [{ id: migratedId, name: migratedName }];
      const migratedProfile = legacyProfile ? sanitizeProfile({ ...DEFAULT_PROFILE, ...legacyProfile }) : DEFAULT_PROFILE;
      saveState(makeProfileKey(migratedId, 'profile'), migratedProfile);
      saveState(makeProfileKey(migratedId, 'slots'), migratedSlots);
      saveState(makeProfileKey(migratedId, 'days'), migratedDays);
      saveState(makeProfileKey(migratedId, 'current_day'), migratedCurrentDay);
      removeState(PROFILE_STORAGE_KEY);
      removeState(LEGACY_PROFILE_STORAGE_KEY);
    }

    if (profilesList.length === 0) {
      const defaultId = generateProfileId();
      profilesList = [{ id: defaultId, name: 'Perfil Principal' }];
      const defaultDays = { [INITIAL_DAY_ID]: getInitialDayState(INITIAL_SLOT_KEYS) };
      saveState(makeProfileKey(defaultId, 'profile'), DEFAULT_PROFILE);
      saveState(makeProfileKey(defaultId, 'slots'), INITIAL_SLOT_KEYS);
      saveState(makeProfileKey(defaultId, 'days'), defaultDays);
      saveState(makeProfileKey(defaultId, 'current_day'), INITIAL_DAY_ID);
    }

    let selectedId = loadState(SELECTED_PROFILE_ID_KEY, profilesList[0]?.id || null);
    if (!profilesList.some(p=>p.id===selectedId)) selectedId = profilesList[0]?.id || null;

    saveState(PROFILES_INDEX_KEY, profilesList);
    if (selectedId) saveState(SELECTED_PROFILE_ID_KEY, selectedId);

    setProfiles(profilesList);
    setSelectedProfileId(selectedId);

    if (selectedId) {
      const bundle = loadProfileBundle(selectedId);
      setProfile(bundle.profile);
      setSlotKeys(bundle.slotKeys);
      setAllDays(bundle.allDays);
      setCurrentDayId(bundle.currentDayId);
      const activeMeta = profilesList.find(p=>p.id===selectedId);
      setProfileNameDraft(activeMeta ? activeMeta.name : '');
    }

    setIsInitialized(true);
    setIsProfileHydrating(false);
  },[]);

  useEffect(()=>{
    if (!isInitialized || !selectedProfileId) return;
    setIsProfileHydrating(true);
    const bundle = loadProfileBundle(selectedProfileId);
    setProfile(bundle.profile);
    setSlotKeys(bundle.slotKeys);
    setAllDays(bundle.allDays);
    setCurrentDayId(bundle.currentDayId);
    const activeMeta = profiles.find(p=>p.id===selectedProfileId);
    setProfileNameDraft(activeMeta ? activeMeta.name : '');
    setIsProfileHydrating(false);
  },[selectedProfileId, isInitialized]);

  useEffect(()=>{
    if (!isInitialized) return;
    const activeMeta = profiles.find(p=>p.id===selectedProfileId);
    setProfileNameDraft(activeMeta ? activeMeta.name : '');
  },[profiles, selectedProfileId, isInitialized]);

  useEffect(()=>{
    if (!isInitialized) return;
    saveState(PROFILES_INDEX_KEY, profiles);
  },[profiles, isInitialized]);

  useEffect(()=>{
    if (!isInitialized || !selectedProfileId) return;
    saveState(SELECTED_PROFILE_ID_KEY, selectedProfileId);
  },[selectedProfileId, isInitialized]);

  useEffect(()=>{
    if (!isInitialized || !selectedProfileId || isProfileHydrating) return;
    saveState(makeProfileKey(selectedProfileId, 'profile'), profile);
  },[profile, selectedProfileId, isInitialized, isProfileHydrating]);

  useEffect(()=>{
    if (!isInitialized || !selectedProfileId || isProfileHydrating) return;
    saveState(makeProfileKey(selectedProfileId, 'days'), allDays);
  },[allDays, selectedProfileId, isInitialized, isProfileHydrating]);

  useEffect(()=>{
    if (!isInitialized || !selectedProfileId || isProfileHydrating) return;
    saveState(makeProfileKey(selectedProfileId, 'current_day'), currentDayId);
  },[currentDayId, selectedProfileId, isInitialized, isProfileHydrating]);

  useEffect(()=>{
    if (!isInitialized || !selectedProfileId || isProfileHydrating) return;
    saveState(makeProfileKey(selectedProfileId, 'slots'), slotKeys);
  },[slotKeys, selectedProfileId, isInitialized, isProfileHydrating]);

  /* UI */
  const [isProfileMinimized, setIsProfileMinimized] = useState(false);
  const [isMacrosMinimized, setIsMacrosMinimized] = useState(false);
  const [isLibraryMinimized, setIsLibraryMinimized] = useState(false);
  const [isDayMinimized, setIsDayMinimized] = useState(false);
  const [selectedBlock, setSelectedBlock] = useState("all");
  const [activeTags, setActiveTags] = useState([]);
  const [search, setSearch] = useState("");
  const [meals, setMeals] = useState(DEFAULT_MEALS);
  const [isMealsLoading, setIsMealsLoading] = useState(true);
  const [mealsError, setMealsError] = useState('');

  const handleSelectProfile = (id) => {
    if (!id || id === selectedProfileId) return;
    setIsProfileHydrating(true);
    setSelectedProfileId(id);
    setIsAddingProfile(false);
  };

  const finalizeProfileName = () => {
    if (!selectedProfileId) return;
    const trimmed = profileNameDraft.trim();
    const fallbackIndex = Math.max(1, profiles.findIndex(p=>p.id===selectedProfileId) + 1);
    const finalName = trimmed.length>0 ? trimmed : `Perfil ${fallbackIndex}`;
    setProfiles(prev=> prev.map(p=> p.id===selectedProfileId ? { ...p, name: finalName } : p));
    setProfileNameDraft(finalName);
  };

  const handleCreateProfile = (name) => {
    const trimmed = name.trim();
    const finalName = trimmed.length>0 ? trimmed : `Perfil ${profiles.length+1}`;
    const newId = generateProfileId();
    const defaultDays = { [INITIAL_DAY_ID]: getInitialDayState(INITIAL_SLOT_KEYS) };
    saveState(makeProfileKey(newId, 'profile'), DEFAULT_PROFILE);
    saveState(makeProfileKey(newId, 'slots'), INITIAL_SLOT_KEYS);
    saveState(makeProfileKey(newId, 'days'), defaultDays);
    saveState(makeProfileKey(newId, 'current_day'), INITIAL_DAY_ID);
    setProfiles(prev=> [...prev, { id: newId, name: finalName }]);
    setIsProfileHydrating(true);
    setProfile(DEFAULT_PROFILE);
    setSlotKeys(INITIAL_SLOT_KEYS);
    setAllDays(defaultDays);
    setCurrentDayId(INITIAL_DAY_ID);
    setProfileNameDraft(finalName);
    setSelectedProfileId(newId);
    setIsAddingProfile(false);
    setNewProfileName('');
  };

  const handleDeleteProfile = () => {
    if (profiles.length<=1 || !selectedProfileId) return;
    const activeMeta = profiles.find(p=>p.id===selectedProfileId);
    const ok = window.confirm(`Excluir o perfil "${activeMeta?.name || 'Atual'}"? Esta ação não pode ser desfeita.`);
    if (!ok) return;
    removeState(makeProfileKey(selectedProfileId, 'profile'));
    removeState(makeProfileKey(selectedProfileId, 'slots'));
    removeState(makeProfileKey(selectedProfileId, 'days'));
    removeState(makeProfileKey(selectedProfileId, 'current_day'));
    const remaining = profiles.filter(p=>p.id!==selectedProfileId);
    setProfiles(remaining);
    const nextId = remaining[0]?.id || null;
    if (nextId) {
      setIsProfileHydrating(true);
      setSelectedProfileId(nextId);
    } else {
      const fallbackId = generateProfileId();
      const fallbackMeta = { id: fallbackId, name: 'Perfil Principal' };
      const fallbackDays = { [INITIAL_DAY_ID]: getInitialDayState(INITIAL_SLOT_KEYS) };
      setProfiles([fallbackMeta]);
      setIsProfileHydrating(true);
      setSelectedProfileId(fallbackId);
      setProfile(DEFAULT_PROFILE);
      setSlotKeys(INITIAL_SLOT_KEYS);
      setAllDays(fallbackDays);
      setCurrentDayId(INITIAL_DAY_ID);
      setProfileNameDraft(fallbackMeta.name);
      saveState(makeProfileKey(fallbackId, 'profile'), DEFAULT_PROFILE);
      saveState(makeProfileKey(fallbackId, 'slots'), INITIAL_SLOT_KEYS);
      saveState(makeProfileKey(fallbackId, 'days'), fallbackDays);
      saveState(makeProfileKey(fallbackId, 'current_day'), INITIAL_DAY_ID);
    }
  };

  /* <<< CORREÇÃO: edição suave + clamp no onBlur >>> */
  const handleProfileChange = (key, value) => {
    if (isProfileLocked) return;
    if (['sex','activity','goal','photoUrl'].includes(key)) {
      setProfile(p => ({ ...p, [key]: value }));
      return;
    }
    const next = value === '' ? '' : Number(value); // permitir vazio durante digitação
    setProfile(p => ({ ...p, [key]: next }));
  };
  const handleProfileBlur = (key, value) => {
    if (isProfileLocked) return;
    if (['sex','activity','goal','photoUrl'].includes(key)) return;
    const finalValue = normalizeAndValidateInput(key, value);
    setProfile(p => ({ ...p, [key]: finalValue }));
  };

  const handlePhotoUpload = (e) => {
    if (isProfileLocked) return;
    const file = e.target.files[0];
    if (file) setProfile(p => ({ ...p, photoUrl: URL.createObjectURL(file) }));
  };

  useEffect(()=>{
    let isMounted = true;
    setIsMealsLoading(true);
    const alimentosUrl = resolveStaticAsset('./alimentos.json');
    fetch(alimentosUrl, { cache: 'no-store' })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
      })
      .then(data => {
        if (!isMounted) return;
        const parsed = Array.isArray(data) ? data : Array.isArray(data?.meals) ? data.meals : [];
        if (parsed.length>0) {
          setMeals(parsed);
          setMealsError('');
        } else {
          setMeals(DEFAULT_MEALS);
          setMealsError('');
        }
        setIsMealsLoading(false);
      })
      .catch(err => {
        if (!isMounted) return;
        console.error('Erro ao carregar alimentos externos', err);
        setMeals(DEFAULT_MEALS);
        setMealsError('Não foi possível carregar o cardápio externo. Usando lista padrão.');
        setIsMealsLoading(false);
      });
    return () => { isMounted = false; };
  },[]);

  /* Cálculos memoizados */
  const bmr = useMemo(()=>calcBMR(profile),[profile]);
  const tdee = useMemo(()=>calcTDEE(bmr, profile.activity),[bmr, profile.activity]);
  const targetCalories = useMemo(()=>round(adjustForGoal(tdee, profile.goal)),[tdee, profile.goal]);
  const macroTargets = useMemo(()=>deriveMacroTargets({ weight: Number(profile.weight)||0, calories: targetCalories }),[profile.weight, targetCalories]);
  const bodyFat = useMemo(()=>{
    const v = calcBF({ ...profile, height:Number(profile.height)||0, neck:Number(profile.neck)||0, waist:Number(profile.waist)||0, hip:Number(profile.hip)||0 });
    return v!=null ? round(v,1) : null;
  },[profile.sex, profile.height, profile.neck, profile.waist, profile.hip]);

  const mealsWithTotals = useMemo(()=> addTotalsToMeals(meals && meals.length>0 ? meals : DEFAULT_MEALS),[meals]);
  const availableTags = useMemo(()=> {
    const tags = new Set();
    mealsWithTotals.forEach(meal => {
      (meal.tags || []).forEach(tag => tags.add(tag));
    });
    return Array.from(tags).sort((a,b)=>a.localeCompare(b));
  },[mealsWithTotals]);

  const filteredMeals = useMemo(()=> mealsWithTotals.filter(m=>{
    const blockOk = selectedBlock==="all" || m.block===selectedBlock;
    const tagOk = activeTags.length===0 || activeTags.every(t=>m.tags.includes(t));
    const searchOk = m.name.toLowerCase().includes(search.toLowerCase());
    return blockOk && tagOk && searchOk;
  }),[selectedBlock, activeTags, search, mealsWithTotals]);

  const totals = useMemo(()=>{
    const all = Object.values(day).flat();
    return all.reduce((acc, mealEntry)=>{
      const mealTotals = mealEntry.ingredients.reduce((a, ing)=>{
        const m = calculateMealMacros(ing);
        a.kcal+=m.kcal; a.protein+=m.protein; a.carbs+=m.carbs; a.fats+=m.fats; return a;
      },{kcal:0,protein:0,carbs:0,fats:0});
      acc.kcal+=mealTotals.kcal; acc.protein+=mealTotals.protein; acc.carbs+=mealTotals.carbs; acc.fats+=mealTotals.fats; return acc;
    },{kcal:0,protein:0,carbs:0,fats:0});
  },[day]);

  if (!isInitialized) {
    return (
      <div className="min-h-screen bg-[#0a0a1a] text-slate-200 font-inter flex items-center justify-center">
        <div className="text-center space-y-2">
          <h1 className="text-xl font-semibold text-white">Carregando seus dados locais...</h1>
          <p className="text-sm text-slate-400">Aguarde enquanto verificamos perfis e refeições salvas neste dispositivo.</p>
        </div>
      </div>
    );
  }

  const getSlotLabel = (key)=>{ const i = slotKeys.indexOf(key); return i===-1 ? key : `Refeição ${i+1}`; };
  const updateDay = (newDay)=> setAllDays(prev=>({ ...prev, [currentDayId]: newDay }));

  function addTo(slotKey, meal){
    const newEntry = { mealId: meal.id, name: meal.name, isLocked:false, ingredients: meal.ingredients.map(ing=>({ ...ing, portion:1 })) };
    updateDay({ ...day, [slotKey]: [...(day[slotKey]||[]), newEntry] });
  }
  const toggleLock = (slotKey, mealIndex)=>{
    updateDay({
      ...day,
      [slotKey]: day[slotKey].map((m,i)=> i!==mealIndex ? m : ({ ...m, isLocked: !m.isLocked }))
    });
  };
  function removeIngredient(slotKey, mealIndex, ingredientIndex){
    updateDay({
      ...day,
      [slotKey]: day[slotKey].map((m,i)=>{
        if (i!==mealIndex || m.isLocked) return m;
        const next = m.ingredients.filter((_,j)=> j!==ingredientIndex);
        if (next.length===0) return null;
        return { ...m, ingredients: next };
      }).filter(Boolean)
    });
  }
  function updateIngredientPortion(slotKey, mealIndex, ingredientIndex, portion){
    updateDay({
      ...day,
      [slotKey]: day[slotKey].map((m,i)=>{
        if (i!==mealIndex || m.isLocked) return m;
        return { ...m, ingredients: m.ingredients.map((ing,j)=> j===ingredientIndex ? { ...ing, portion } : ing) };
      })
    });
  }
  function removeMeal(slotKey, mealIndex){
    updateDay({ ...day, [slotKey]: day[slotKey].filter((_,i)=> i!==mealIndex) });
  }
  function addSlot(){
    if (slotKeys.length>=8) return;
    const newKey = `slot-${slotKeys.length+1}`;
    setSlotKeys(prev=>[...prev,newKey]);
    setAllDays(prev=>{
      const up={...prev};
      Object.keys(up).forEach(id=>{ up[id] = { ...up[id], [newKey]: [] }; });
      return up;
    });
  }
  function removeSlot(keyToRemove){
    if (slotKeys.length<=1) return;
    setSlotKeys(prev=> prev.filter(k=>k!==keyToRemove));
    setAllDays(prev=>{
      const up={...prev};
      Object.keys(up).forEach(id=>{
        const { [keyToRemove]:_, ...rest } = up[id]; up[id] = rest;
      });
      return up;
    });
  }
  function resetDay(){ updateDay(getInitialDayState(slotKeys)); }
  function duplicateCurrentDay(){
    const ids = Object.keys(allDays);
    const last = ids.reduce((mx,id)=>{ const m=id.match(/day-(\d+)/); return m?Math.max(mx,parseInt(m[1],10)):mx; },0);
    const newId = `day-${last+1}`;
    setAllDays(prev=>({ ...prev, [newId]: JSON.parse(JSON.stringify(day)) }));
    setCurrentDayId(newId);
  }

  const dayOptions = Object.keys(allDays).sort((a,b)=>(parseInt(a.split('-')[1],10)||0)-(parseInt(b.split('-')[1],10)||0));
  const getDayLabel = (id)=>`Dia ${dayOptions.indexOf(id)+1}`;

  const ProfilePhotoUploader = ({ photoUrl, handleUpload, isDisabled }) => (
    <div className={`flex flex-col items-center mb-4 ${isDisabled ? 'opacity-50':''}`}>
      <label htmlFor="profile-photo-upload" className={isDisabled ? '' : 'cursor-pointer'}>
        <img src={photoUrl} alt="Foto de Perfil" className={`w-24 h-24 rounded-full object-cover border-4 border-slate-600 transition duration-150 ${isDisabled?'grayscale':'hover:border-emerald-500'}`} onError={(e)=> e.target.src = DEFAULT_PROFILE.photoUrl }/>
        <input id="profile-photo-upload" type="file" accept="image/*" onChange={handleUpload} className="hidden" disabled={isDisabled}/>
      </label>
      <p className="text-xs text-slate-400 mt-2">{isDisabled ? 'Informações fixadas' : 'Clique para alterar foto'}</p>
    </div>
  );

  /* UI */
  return (
    <div className="min-h-screen bg-[#0a0a1a] text-slate-200 font-inter">
      <header className="px-6 py-5 border-b border-slate-700/60 sticky top-0 bg-[#0a0a1a]/90 backdrop-blur z-20">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold tracking-tight text-white">Cardápio Inteligente</h1>
            <p className="text-sm text-slate-400">Monte seu dia com porções ajustáveis e metas calculadas (v5.7)</p>
          </div>
          <div className="hidden md:flex items-center gap-3">
            <a href="#biblioteca" className="text-sm px-3 py-1 rounded border border-slate-600 hover:bg-slate-700/40 transition">Biblioteca</a>
            <a href="#meu-dia" className="text-sm px-3 py-1 rounded border border-slate-600 hover:bg-slate-700/40 transition">Meu Dia</a>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-6 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Coluna 1 */}
        <div className="lg:col-span-1 flex flex-col gap-6">
          {/* Perfil */}
          <div className="bg-slate-800/70 rounded-2xl p-5 shadow-lg shadow-black/20 border border-slate-700/50">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-slate-100 text-lg font-semibold tracking-tight">Seu Perfil</h2>
              <div className="flex gap-2 items-center">
                <button onClick={()=>setIsProfileLocked(p=>!p)} className={`text-xs px-2 py-0.5 rounded transition font-semibold border focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 ${isProfileLocked ? 'border-red-500 text-red-300 bg-red-900/20 hover:bg-red-500/20 focus:ring-red-500' : 'border-emerald-500 text-emerald-300 bg-emerald-900/20 hover:bg-emerald-500/20 focus:ring-emerald-500'}`}>
                  {isProfileLocked ? 'Editar' : 'Trancar Perfil'}
                </button>
                <MinimizeButton isMinimized={isProfileMinimized} toggleMinimize={()=>setIsProfileMinimized(p=>!p)} />
              </div>
            </div>

            <div className="mt-4">
              <div className="mb-5 space-y-4">
                <div>
                  <label className="text-xs uppercase tracking-wide text-slate-400 block mb-2">Perfil ativo neste dispositivo</label>
                  <div className="flex flex-col sm:flex-row sm:items-center gap-2">
                    <select value={selectedProfileId || ''} onChange={(e)=>handleSelectProfile(e.target.value)} className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                      {profiles.map(meta=> (<option key={meta.id} value={meta.id}>{meta.name}</option>))}
                    </select>
                    <div className="flex gap-2">
                      <button onClick={()=>{ setIsAddingProfile(true); setNewProfileName(''); }} disabled={isAddingProfile} className={`text-xs px-3 py-2 rounded border transition focus:outline-none focus:ring-1 focus:ring-emerald-500 ${isAddingProfile ? 'border-slate-700 text-slate-500 cursor-not-allowed' : 'border-emerald-500 text-emerald-300 hover:bg-emerald-500/10'}`}>+ Novo</button>
                      <button onClick={handleDeleteProfile} disabled={profiles.length<=1} className={`text-xs px-3 py-2 rounded border transition focus:outline-none focus:ring-1 focus:ring-red-500 ${profiles.length<=1 ? 'border-slate-700 text-slate-500 cursor-not-allowed' : 'border-red-500 text-red-300 hover:bg-red-500/10'}`}>Excluir</button>
                    </div>
                  </div>
                </div>

                <div>
                  <label className="text-xs text-slate-400 block mb-1">Nome do perfil</label>
                  <input value={profileNameDraft} onChange={(e)=>setProfileNameDraft(e.target.value)} onBlur={finalizeProfileName} onKeyDown={(e)=>{ if (e.key==='Enter'){ e.preventDefault(); finalizeProfileName(); e.currentTarget.blur(); } }} className="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" placeholder="Ex.: Leo, Jaque, Bulking" />
                  <p className="text-[11px] text-slate-500 mt-1">Cada perfil guarda metas, refeições e slots de forma independente.</p>
                </div>

                {isAddingProfile && (
                  <form onSubmit={(e)=>{ e.preventDefault(); handleCreateProfile(newProfileName); }} className="bg-slate-900/60 border border-slate-700 rounded-xl p-3 flex flex-col sm:flex-row sm:items-center gap-3">
                    <input value={newProfileName} onChange={(e)=>setNewProfileName(e.target.value)} className="flex-1 bg-slate-950 border border-slate-700 rounded px-3 py-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" placeholder="Nome do novo perfil" autoFocus />
                    <div className="flex gap-2">
                      <button type="submit" className="text-xs px-3 py-2 rounded border border-emerald-500 text-emerald-300 hover:bg-emerald-500/10 transition focus:outline-none focus:ring-1 focus:ring-emerald-500">Salvar</button>
                      <button type="button" onClick={()=>{ setIsAddingProfile(false); setNewProfileName(''); }} className="text-xs px-3 py-2 rounded border border-slate-600 text-slate-400 hover:bg-slate-800/60 transition focus:outline-none focus:ring-1 focus:ring-slate-500">Cancelar</button>
                    </div>
                  </form>
                )}

                {isProfileHydrating && (
                  <p className="text-xs text-slate-400">Carregando dados do perfil selecionado...</p>
                )}
              </div>
              <ProfilePhotoUploader photoUrl={profile.photoUrl} handleUpload={handlePhotoUpload} isDisabled={isProfileLocked}/>
              {!isProfileMinimized && (
                <div className={`${isProfileLocked ? 'opacity-70 cursor-not-allowed':''}`} title={isProfileLocked ? "Perfil trancado" : undefined}>
                  {/* Dados pessoais */}
                  <div className="grid grid-cols-2 gap-3 text-sm border-b border-slate-700 pb-4 mb-4">
                    <label className="flex flex-col gap-1">
                      <span className="text-slate-300">Sexo</span>
                      <select value={profile.sex} onChange={(e)=>handleProfileChange('sex',e.target.value)} className={`bg-slate-900 border border-slate-600 rounded px-2 py-2 focus:ring-emerald-500 focus:border-emerald-500 ${isProfileLocked?'cursor-not-allowed':''}`} disabled={isProfileLocked}>
                        <option value="M">Masculino</option><option value="F">Feminino</option>
                      </select>
                    </label>
                    <label className="flex flex-col gap-1">
                      <span className="text-slate-300">Idade</span>
                      <input type="number" min={INPUT_RANGES.age.min} max={INPUT_RANGES.age.max} step={INPUT_RANGES.age.step}
                        value={profile.age} onChange={(e)=>handleProfileChange('age',e.target.value)} onBlur={(e)=>handleProfileBlur('age',e.target.value)}
                        className={`bg-slate-900 border border-slate-600 rounded px-2 py-2 focus:ring-emerald-500 focus:border-emerald-500 ${isProfileLocked?'cursor-not-allowed':''}`} disabled={isProfileLocked}/>
                    </label>
                    <label className="flex flex-col gap-1">
                      <span className="text-slate-300">Peso (kg)</span>
                      <input type="number" min={INPUT_RANGES.weight.min} max={INPUT_RANGES.weight.max} step={INPUT_RANGES.weight.step}
                        value={profile.weight} onChange={(e)=>handleProfileChange('weight',e.target.value)} onBlur={(e)=>handleProfileBlur('weight',e.target.value)}
                        className={`bg-slate-900 border border-slate-600 rounded px-2 py-2 focus:ring-emerald-500 focus:border-emerald-500 ${isProfileLocked?'cursor-not-allowed':''}`} disabled={isProfileLocked}/>
                    </label>
                    <label className="flex flex-col gap-1">
                      <span className="text-slate-300">Altura (cm)</span>
                      <input type="number" min={INPUT_RANGES.height.min} max={INPUT_RANGES.height.max} step={INPUT_RANGES.height.step}
                        value={profile.height} onChange={(e)=>handleProfileChange('height',e.target.value)} onBlur={(e)=>handleProfileBlur('height',e.target.value)}
                        className={`bg-slate-900 border border-slate-600 rounded px-2 py-2 focus:ring-emerald-500 focus:border-emerald-500 ${isProfileLocked?'cursor-not-allowed':''}`} disabled={isProfileLocked}/>
                    </label>
                  </div>

                  {/* Circunferências */}
                  <span className="text-slate-300 font-semibold text-sm block mb-3">Medidas (Cálculo % Gordura)</span>
                  <div className="grid grid-cols-2 gap-3 text-sm border-b border-slate-700 pb-4 mb-4">
                    <label className="flex flex-col gap-1">
                      <span className="text-slate-300">Pescoço (cm)</span>
                      <input type="number" min={INPUT_RANGES.neck.min} max={INPUT_RANGES.neck.max} step={INPUT_RANGES.neck.step}
                        value={profile.neck} onChange={(e)=>handleProfileChange('neck',e.target.value)} onBlur={(e)=>handleProfileBlur('neck',e.target.value)}
                        className={`bg-slate-900 border border-slate-600 rounded px-2 py-2 focus:ring-emerald-500 focus:border-emerald-500 ${isProfileLocked?'cursor-not-allowed':''}`} disabled={isProfileLocked}/>
                    </label>
                    <label className="flex flex-col gap-1">
                      <span className="text-slate-300">Cintura (cm)</span>
                      <input type="number" min={INPUT_RANGES.waist.min} max={INPUT_RANGES.waist.max} step={INPUT_RANGES.waist.step}
                        value={profile.waist} onChange={(e)=>handleProfileChange('waist',e.target.value)} onBlur={(e)=>handleProfileBlur('waist',e.target.value)}
                        className={`bg-slate-900 border border-slate-600 rounded px-2 py-2 focus:ring-emerald-500 focus:border-emerald-500 ${isProfileLocked?'cursor-not-allowed':''}`} disabled={isProfileLocked}/>
                    </label>
                    {profile.sex === 'F' && (
                      <label className="flex flex-col gap-1 col-span-2">
                        <span className="text-slate-300">Quadril (cm)</span>
                        <input type="number" min={INPUT_RANGES.hip.min} max={INPUT_RANGES.hip.max} step={INPUT_RANGES.hip.step}
                          value={profile.hip} onChange={(e)=>handleProfileChange('hip',e.target.value)} onBlur={(e)=>handleProfileBlur('hip',e.target.value)}
                          className={`bg-slate-900 border border-slate-600 rounded px-2 py-2 focus:ring-emerald-500 focus:border-emerald-500 ${isProfileLocked?'cursor-not-allowed':''}`} disabled={isProfileLocked}/>
                      </label>
                    )}
                    <p className="text-slate-500 text-xs mt-1 col-span-2">
                      {bodyFat === null && profile.sex === 'F' && '⚠️ Altura, Pescoço, Cintura E Quadril são necessários para o %BF Feminino.'}
                      {bodyFat === null && profile.sex === 'M' && '⚠️ Altura, Pescoço E Cintura são necessários para o %BF Masculino.'}
                    </p>
                  </div>

                  {/* Atividade / Objetivo */}
                  <div className="grid grid-cols-1 gap-3 text-sm">
                    <label className="flex flex-col gap-1">
                      <span className="text-slate-300">Nível de Atividade</span>
                      <select value={profile.activity} onChange={(e)=>handleProfileChange('activity',e.target.value)} className={`bg-slate-900 border border-slate-600 rounded px-2 py-2 focus:ring-emerald-500 focus:border-emerald-500 ${isProfileLocked?'cursor-not-allowed':''}`} disabled={isProfileLocked}>
                        <option value="sedentary">Sedentário</option>
                        <option value="light">Leve (1–3x/sem)</option>
                        <option value="moderate">Moderado (3–5x/sem)</option>
                        <option value="active">Ativo (6–7x/sem)</option>
                        <option value="very">Muito ativo</option>
                      </select>
                    </label>
                    <label className="flex flex-col gap-1">
                      <span className="text-slate-300">Objetivo</span>
                      <select value={profile.goal} onChange={(e)=>handleProfileChange('goal',e.target.value)} className={`bg-slate-900 border border-slate-600 rounded px-2 py-2 focus:ring-emerald-500 focus:border-emerald-500 ${isProfileLocked?'cursor-not-allowed':''}`} disabled={isProfileLocked}>
                        <option value="loss">Emagrecer (déficit)</option>
                        <option value="maintain">Manter</option>
                        <option value="gain">Ganhar (superávit)</option>
                        <option value="recomp">Recomposição (leve déficit, 5%)</option>
                      </select>
                    </label>
                  </div>

                  {/* Resultados */}
                  <div className="mt-4 grid grid-cols-2 gap-3 text-sm">
                    <div className="p-3 rounded bg-slate-900 border border-slate-700">
                      <div className="text-slate-400">TDEE alvo</div>
                      <div className="text-xl font-semibold text-emerald-400">{round(targetCalories)}</div>
                      <div className="text-slate-500 text-xs">kcal/dia</div>
                    </div>
                    <div className="p-3 rounded bg-slate-900 border border-slate-700">
                      <div className="text-slate-400">% Gordura Est. (BF)</div>
                      <div className={`text-xl font-semibold ${bodyFat !== null ? 'text-white' : 'text-yellow-500'}`}>
                        {bodyFat !== null ? `${bodyFat}%` : 'Dados Incompletos'}
                      </div>
                      <div className="text-slate-500 text-xs">Fórmula Marinha EUA</div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Metas de Macros */}
          <Section title="Metas de Macros" isMinimized={isMacrosMinimized} right={<MinimizeButton isMinimized={isMacrosMinimized} toggleMinimize={()=>setIsMacrosMinimized(p=>!p)} />}>
            <Stat label="Calorias" value={totals.kcal} unit=" kcal" target={targetCalories} />
            <Stat label="Proteínas" value={totals.protein} unit=" g" target={macroTargets.protein} />
            <Stat label="Carboidratos" value={totals.carbs} unit=" g" target={macroTargets.carbs} />
            <Stat label="Gorduras" value={totals.fats} unit=" g" target={macroTargets.fats} />
            <div className="text-xs text-slate-400 mt-2">* Metas calculadas por g/kg (P: 1.8 | G: 0.8). Ajuste seu perfil para recalcular.</div>
          </Section>
        </div>

        {/* Coluna 2 */}
        <div className="lg:col-span-2 grid grid-cols-1 xl:grid-cols-2 gap-6">
          {/* Biblioteca */}
          <Section
            title="Biblioteca de Refeições"
            isMinimized={isLibraryMinimized}
            right={
              <div className="flex items-center gap-2 flex-wrap justify-end">
                <input value={search} onChange={(e)=>setSearch(e.target.value)} placeholder="Buscar refeição..." className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm w-full md:w-48 focus:ring-emerald-500 focus:border-emerald-500"/>
                <select value={selectedBlock} onChange={(e)=>setSelectedBlock(e.target.value)} className="bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm focus:ring-emerald-500 focus:border-emerald-500">
                  <option value="all">Todos os blocos</option>
                  <option value="250">250 kcal (Snack/Pré-Cama)</option>
                  <option value="350">350 kcal (Lanche/Café)</option>
                  <option value="500">500 kcal (Padrão)</option>
                  <option value="750">750 kcal (Alta Energia)</option>
                </select>
                <MinimizeButton isMinimized={isLibraryMinimized} toggleMinimize={()=>setIsLibraryMinimized(p=>!p)} />
              </div>
            }
          >
            <div className="flex flex-wrap mb-3">
              {availableTags.map(t=>(
                <Pill key={t} active={activeTags.includes(t)} onClick={()=>setActiveTags(prev=> prev.includes(t) ? prev.filter(x=>x!==t) : [...prev,t])}>{t}</Pill>
              ))}
              {activeTags.length>0 && (
                <button onClick={()=>setActiveTags([])} className="text-xs text-slate-400 underline ml-2 hover:text-white transition focus:outline-none focus:ring-1 focus:ring-slate-400 rounded">limpar tags</button>
              )}
            </div>

            <div id="biblioteca" className="grid md:grid-cols-2 gap-4 max-h-[500px] overflow-y-auto pr-2">
              {isMealsLoading && (
                <div className="text-slate-400 text-sm md:col-span-2 p-4 border border-dashed border-slate-700 rounded-xl text-center">Carregando cardápio atualizado...</div>
              )}
              {filteredMeals.map(m=>(
                <div key={m.id} className="rounded-xl border border-slate-700 bg-slate-900 p-4 transition-shadow hover:shadow-emerald-500/10 hover:shadow-xl">
                  <div className="flex items-start justify-between">
                    <div>
                      <div className="font-semibold text-slate-100">{m.name}</div>
                      <div className="text-sm text-slate-400">{round(m.kcal)} kcal • P {round(m.protein)}g • C {round(m.carbs)}g • G {round(m.fats)}g</div>
                    </div>
                    <span className="text-xs px-2 py-1 rounded-full bg-amber-500/20 text-amber-300 border border-amber-500/40">{m.block} kcal</span>
                  </div>
                  <div className="mt-3 flex flex-wrap gap-2">
                    {m.tags.map(t=> (<span key={t} className="text-xs px-2 py-1 rounded-full bg-slate-800 border border-slate-600 text-slate-300">{t}</span>))}
                  </div>
                  <div className="mt-4 flex flex-wrap gap-2">
                    {slotKeys.map(slotKey=>(
                      <button key={slotKey} onClick={()=>addTo(slotKey,m)} className="text-xs px-2 py-1 rounded border border-emerald-500 text-emerald-300 hover:bg-emerald-500/10 transition focus:outline-none focus:ring-1 focus:ring-emerald-500">+ {getSlotLabel(slotKey)}</button>
                    ))}
                  </div>
                </div>
              ))}
              {!isMealsLoading && filteredMeals.length===0 && (
                <div className="text-slate-400 text-sm md:col-span-2 p-4 border border-dashed border-slate-700 rounded-xl text-center">Nenhuma refeição encontrada. Limpe os filtros.</div>
              )}
            </div>
            {mealsError && <p className="text-xs text-amber-300 mt-2">{mealsError}</p>}
          </Section>

          {/* Meu Dia */}
          <Section
            title="Meu Dia"
            isMinimized={isDayMinimized}
            right={
              <div className="flex gap-2 flex-wrap justify-end">
                <select value={currentDayId} onChange={(e)=>setCurrentDayId(e.target.value)} className="bg-slate-900 border border-blue-600 rounded px-3 py-1 text-sm text-blue-300 focus:ring-blue-500 focus:border-blue-500 font-semibold">
                  {dayOptions.map(id=> (<option key={id} value={id}>{getDayLabel(id)}</option>))}
                </select>
                <button onClick={duplicateCurrentDay} className="text-sm px-3 py-1 rounded border border-purple-500 text-purple-300 hover:bg-purple-900/40 hover:border-purple-400 transition focus:outline-none focus:ring-1 focus:ring-purple-500">Duplicar Plano</button>
                <button onClick={resetDay} className="text-sm px-3 py-1 rounded border border-slate-600 text-slate-400 hover:bg-red-900/40 hover:border-red-500 transition focus:outline-none focus:ring-1 focus:ring-red-500">Resetar Conteúdo</button>
                <button onClick={addSlot} disabled={slotKeys.length>=8} className={`text-sm px-3 py-1 rounded border transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-800 ${slotKeys.length>=8?'border-slate-700 text-slate-600 cursor-not-allowed':'border-blue-500 text-blue-300 hover:bg-blue-500/10 focus:ring-blue-500'}`}>+ Refeição</button>
                <MinimizeButton isMinimized={isDayMinimized} toggleMinimize={()=>setIsDayMinimized(p=>!p)} />
              </div>
            }
          >
            <div id="meu-dia" className="grid md:grid-cols-1 gap-4 max-h-[500px] overflow-y-auto pr-2">
              {slotKeys.map(slotKey=>(
                <div key={slotKey} className="rounded-xl border border-slate-700 bg-slate-900 p-4">
                  <div className="flex justify-between items-center mb-2">
                    <div className="font-semibold text-slate-100">{getSlotLabel(slotKey)}</div>
                    {slotKeys.length>1 && (
                      <button onClick={()=>removeSlot(slotKey)} className="text-xs px-2 py-1 rounded border border-red-700 text-red-500 hover:bg-red-900/20 transition focus:outline-none focus:ring-1 focus:ring-red-500">Remover Slot</button>
                    )}
                  </div>

                  {(!day[slotKey] || day[slotKey].length===0) ? (
                    <div className="text-slate-500 text-sm p-4 border border-dashed border-slate-700 rounded-lg text-center">Vazio — adicione refeições da biblioteca.</div>
                  ) : (
                    <ul className="space-y-3">
                      {day[slotKey].map((mealEntry, mealIndex)=>(
                        <li key={mealIndex} className={`p-3 border rounded-xl shadow-inner ${mealEntry.isLocked?'border-emerald-500/50 bg-emerald-900/10':'border-slate-700 bg-slate-900/50'}`}>
                          <div className="flex justify-between items-start mb-3">
                            <div className="text-base text-emerald-400 font-bold flex items-center gap-2">
                              {mealEntry.name}
                              {mealEntry.isLocked && (
                                <svg className="w-4 h-4 text-emerald-500" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"></path></svg>
                              )}
                            </div>
                            <div className="flex gap-2 items-center flex-shrink-0">
                              <button onClick={()=>toggleLock(slotKey, mealIndex)} className={`text-xs px-2 py-0.5 rounded transition font-semibold focus:outline-none focus:ring-1 focus:ring-offset-2 focus:ring-offset-slate-800 ${mealEntry.isLocked?'border border-red-500 text-red-300 bg-red-900/20 hover:bg-red-500/20 focus:ring-red-500':'border border-emerald-500 text-emerald-300 bg-emerald-900/20 hover:bg-emerald-500/20 focus:ring-emerald-500'}`}>{mealEntry.isLocked?'Editar':'Feita'}</button>
                              <button onClick={()=>removeMeal(slotKey, mealIndex)} className="text-xs px-2 py-0.5 rounded border border-slate-600 text-slate-400 hover:bg-red-500/10 transition focus:outline-none focus:ring-1 focus:ring-slate-400">Remover</button>
                            </div>
                          </div>

                          <p className="text-xs text-slate-400 mb-2 font-medium">Ingredientes:</p>
                          <ul className="space-y-2">
                            {mealEntry.ingredients.map((ing, iIdx)=>{
                              const macros = calculateMealMacros(ing);
                              const disabled = mealEntry.isLocked;
                              return (
                                <li key={iIdx} className={`flex justify-between items-center text-xs pl-3 py-1 border-l-2 ${disabled?'border-emerald-500/50':'border-slate-700 hover:bg-slate-800/50'} rounded-sm`}>
                                  <div className="text-slate-300 flex-1 truncate">{ing.name} (<strong className="text-slate-200">{round(macros.kcal)} kcal</strong>)</div>
                                  <div className="flex items-center gap-2 flex-shrink-0">
                                    <select value={ing.portion} onChange={(e)=>updateIngredientPortion(slotKey, mealIndex, iIdx, Number(e.target.value))} className={`bg-slate-700 border rounded px-1 py-0.5 text-xs text-white w-20 transition focus:outline-none focus:ring-1 focus:ring-blue-500 ${disabled?'opacity-50 cursor-not-allowed border-slate-700':'border-slate-600'}`} disabled={disabled}>
                                      {PORTION_OPTIONS.map(p=>(<option key={p} value={p}>{p}x</option>))}
                                    </select>
                                    <button onClick={()=>removeIngredient(slotKey, mealIndex, iIdx)} className={`text-xs p-1 rounded transition focus:outline-none focus:ring-1 focus:ring-red-400 ${disabled?'text-slate-600 cursor-not-allowed':'text-red-400 hover:text-red-300 hover:bg-red-900/20'}`} disabled={disabled}>
                                      <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd"/></svg>
                                    </button>
                                  </div>
                                </li>
                              );
                            })}
                          </ul>
                        </li>
                      ))}
                    </ul>
                  )}
                </div>
              ))}
            </div>

            <div className="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3 border-t border-slate-700 pt-4">
              <div className="p-3 rounded bg-slate-700 border border-slate-600 text-center shadow-md shadow-emerald-900/20"><div className="text-slate-400 text-xs">Calorias</div><div className="text-xl font-bold text-white">{round(totals.kcal)}</div></div>
              <div className="p-3 rounded bg-slate-700 border border-slate-600 text-center"><div className="text-slate-400 text-xs">Proteínas</div><div className="text-xl font-bold text-white">{round(totals.protein)} g</div></div>
              <div className="p-3 rounded bg-slate-700 border border-slate-600 text-center"><div className="text-slate-400 text-xs">Carboidratos</div><div className="text-xl font-bold text-white">{round(totals.carbs)} g</div></div>
              <div className="p-3 rounded bg-slate-700 border border-slate-600 text-center"><div className="text-slate-400 text-xs">Gorduras</div><div className="text-xl font-bold text-white">{round(totals.fats)} g</div></div>
            </div>
          </Section>
        </div>
      </main>

      <footer className="max-w-7xl mx-auto px-6 py-10 text-center text-xs text-slate-500">
        MVP visual v5.7. Perfis locais independentes + cardápio carregado via JSON.
      </footer>
    </div>
  );
}

/* Render */
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
  </script>
</body>
</html>
